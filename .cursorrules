---
description: "Gu√≠a de desarrollo Backend (Laravel) para Zonix Eats"
alwaysApply: true
---

## üéØ ESTADO ACTUAL DEL PROYECTO

**Versi√≥n:** 1.0.0  
**Laravel:** 10.x  
**PHP:** 8.1+  
**Estado:** ‚úÖ MVP Completado - En desarrollo activo  
**Tests:** 204 tests pasaron ‚úÖ, 0 tests fallaron ‚úÖ (verificado: `php artisan test` - Enero 2025)  
**Endpoints:** 232 rutas REST (verificado en `routes/api.php`)  
**Controladores:** 52 (verificado)  
**Modelos:** 31 (verificado)  
**Migraciones:** 45 (verificado)  
**L√≠neas de c√≥digo:** 12,898 l√≠neas PHP en `app/`  
**Errores cr√≠ticos:** ‚úÖ Todos corregidos (valores hardcoded, OSRM integrado, analytics reales)  
**√öltima actualizaci√≥n:** Enero 2025

---

## REGLAS FUNDAMENTALES DE COLABORACI√ìN

**IMPORTANTE: El usuario es el l√≠der del proyecto. El asistente debe:**

1. **SIEMPRE PREGUNTAR** antes de realizar cualquier acci√≥n
2. **NUNCA crear archivos nuevos** si es para editar c√≥digo existente
3. **SIEMPRE sugerir detalladamente** qu√© hacer y esperar aprobaci√≥n
4. **NUNCA hacer push a git** sin orden expl√≠cita del usuario
5. **NUNCA hacer merge a git** sin orden expl√≠cita del usuario
6. **El usuario tiene el mando** - el asistente sugiere, el usuario decide

**Flujo de trabajo:**
- Asistente: "Sugiero hacer X, ¬øquieres que proceda?"
- Usuario: "S√≠, hazlo" o "No, mejor Y"
- Asistente: Ejecuta solo lo aprobado

**CR√çTICO - Control de Git:**
- ‚ùå **NUNCA hacer push autom√°ticamente** - Solo cuando el usuario lo ordene expl√≠citamente
- ‚ùå **NUNCA hacer merge autom√°ticamente** - Solo cuando el usuario lo ordene expl√≠citamente
- ‚úÖ **Solo hacer commits locales** cuando se realicen cambios
- ‚úÖ **Esperar aprobaci√≥n del usuario** antes de cualquier push o merge
- ‚úÖ **El usuario prueba primero** y da la orden cuando est√° seguro

---

## ARQUITECTURA Y ESTRUCTURA

### Estructura del Proyecto

```
zonix-eats-back/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ Http/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Controllers/     # Controladores organizados por m√≥dulos
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Authenticator/  # Autenticaci√≥n
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Buyer/          # Funcionalidades de comprador
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Commerce/       # Funcionalidades de comercio
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Delivery/       # Funcionalidades de delivery
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Admin/          # Funcionalidades de administrador
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Middleware/      # Middleware personalizado
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RoleMiddleware.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Requests/        # Validaci√≥n de requests
‚îÇ   ‚îú‚îÄ‚îÄ Models/              # Modelos Eloquent (31 modelos verificados)
‚îÇ   ‚îú‚îÄ‚îÄ Services/            # Servicios de negocio (9 servicios)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ OrderService.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CartService.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ProductService.php
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îú‚îÄ‚îÄ Events/              # Eventos para broadcasting
‚îÇ   ‚îî‚îÄ‚îÄ Providers/           # Proveedores de servicios
‚îú‚îÄ‚îÄ database/
‚îÇ   ‚îú‚îÄ‚îÄ migrations/          # 45 migraciones (verificado)
‚îÇ   ‚îî‚îÄ‚îÄ seeders/             # Seeders de datos
‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îî‚îÄ‚îÄ api.php              # 232 endpoints (verificado)
‚îî‚îÄ‚îÄ tests/
    ‚îî‚îÄ‚îÄ Feature/             # 204 tests pasaron ‚úÖ, 0 tests fallaron ‚úÖ (verificado Enero 2025)
```

### Patr√≥n Arquitect√≥nico

**MVC con separaci√≥n de servicios:**
- **Controllers:** Manejan requests/responses HTTP
- **Services:** Contienen l√≥gica de negocio
- **Models:** Representan entidades de base de datos
- **Events:** Para broadcasting y notificaciones

**Principios a seguir:**
- ‚úÖ Single Responsibility Principle (SRP)
- ‚úÖ Dependency Injection
- ‚úÖ Separation of Concerns
- ‚úÖ DRY (Don't Repeat Yourself)

---

## CONVENCIONES DE C√ìDIGO

### Nomenclatura

- **Archivos:** snake_case (ej: `order_service.php`)
- **Clases:** PascalCase (ej: `OrderService`)
- **M√©todos:** camelCase (ej: `getUserOrders()`)
- **Variables:** camelCase (ej: `$orderId`)
- **Constantes:** UPPER_SNAKE_CASE (ej: `MAX_RETRY_ATTEMPTS`)

### Estructura de Controladores

```php
<?php

namespace App\Http\Controllers\Buyer;

use App\Http\Controllers\Controller;
use App\Services\OrderService;
use Illuminate\Http\Request;

class OrderController extends Controller
{
    protected $orderService;

    public function __construct(OrderService $orderService)
    {
        $this->orderService = $orderService;
    }

    /**
     * Listar √≥rdenes del comprador
     * 
     * @return \Illuminate\Http\JsonResponse
     */
    public function index()
    {
        $orders = $this->orderService->getUserOrders();
        return response()->json([
            'success' => true,
            'data' => $orders
        ]);
    }
}
```

### Estructura de Servicios

```php
<?php

namespace App\Services;

use App\Models\Order;
use Illuminate\Support\Facades\Auth;

class OrderService
{
    /**
     * Obtener √≥rdenes del usuario autenticado
     *
     * @return \Illuminate\Database\Eloquent\Collection
     */
    public function getUserOrders()
    {
        $user = Auth::user();
        $profile = $user->profile;
        
        if (!$profile) {
            return collect();
        }
        
        return Order::where('profile_id', $profile->id)
            ->with(['commerce', 'orderItems.product'])
            ->orderBy('created_at', 'desc')
            ->get();
    }
}
```

### Validaci√≥n de Requests

**SIEMPRE usar Form Requests para validaci√≥n:**

```php
// app/Http/Requests/StoreOrderRequest.php
<?php

namespace App\Http\Requests;

use Illuminate\Foundation\Http\FormRequest;

class StoreOrderRequest extends FormRequest
{
    public function rules()
    {
        return [
            'commerce_id' => 'required|exists:commerces,id',
            'products' => 'required|array|min:1',
            'products.*.id' => 'required|exists:products,id',
            'products.*.quantity' => 'required|integer|min:1',
            'delivery_type' => 'required|in:pickup,delivery',
            'total' => 'required|numeric|min:0',
        ];
    }
}
```

---

## ROLES Y PERMISOS

### Roles del Sistema (MVP)

**Roles implementados y funcionales:**
- **users** (Level 0): Cliente/Comprador ‚úÖ
- **commerce** (Level 1): Comercio/Restaurante ‚úÖ
- **delivery** (Level 2): Repartidor/Delivery ‚úÖ (con jerarqu√≠a: Delivery Company y Delivery Agent)
- **admin** (Level 3): Administrador ‚úÖ

**IMPORTANTE:** Solo existen estos 4 roles. Los roles `transport` y `affiliate` fueron eliminados del c√≥digo.

### Datos Requeridos por Rol

**USERS (Comprador):**
- **M√≠nimos para orden:** firstName, lastName, phone, photo_users (required)
- **Direcciones:** 2 direcciones (predeterminada casa con `is_default=true` + direcci√≥n de entrega)
- **Ubicaci√≥n:** GPS + inputs y selects para mayor precisi√≥n
- **Campos direcci√≥n:** street, house_number, postal_code, latitude, longitude, city_id, is_default

**COMMERCE (Vendedor):**
- **Requeridos:** firstName, lastName, phone, address, business_name, business_type, tax_id
- **Opcionales:** 16 campos (6 del perfil, 5 del comercio, 3 relaciones, 2 del sistema)
- **Comercio:** image (logo), phone, address, open, schedule

**DELIVERY:**
- **Delivery Company:** firstName, lastName, phone, address, photo_users (required) + datos empresa
- **Delivery Agent:** firstName, lastName, phone, address, photo_users (required), vehicle_type, license_number
- **Delivery Company opcionales:** image (logo), phone, address, open, schedule (igual que COMMERCE)
- **Puede ser independiente:** company_id = null

**IMPORTANTE:** Ver README.md secci√≥n "üìã DATOS REQUERIDOS POR ACCI√ìN Y ROL" para detalles completos.

### Middleware de Roles

```php
// Usar middleware de roles en rutas
Route::middleware(['auth:sanctum', 'role:commerce'])->group(function () {
    Route::get('/commerce/dashboard', [DashboardController::class, 'index']);
});
```

**IMPORTANTE:** El middleware `RoleMiddleware` actualmente solo verifica igualdad exacta. Para mejoras futuras, considerar sistema de permisos m√°s granular.

---

## AUTENTICACI√ìN Y SEGURIDAD

### Laravel Sanctum

**Configuraci√≥n:**
- Tokens almacenados en `personal_access_tokens`
- Tokens con expiraci√≥n configurable
- Revocaci√≥n de tokens en logout

**Uso:**
```php
// Crear token
$token = $user->createToken('AuthToken')->plainTextToken;

// Revocar tokens
$request->user()->tokens()->delete();
```

### Seguridad

**CR√çTICO - CORS:**
- ‚ö†Ô∏è Actualmente configurado con `allowed_origins: ['*']`
- **Recomendaci√≥n:** Restringir a dominios espec√≠ficos en producci√≥n

**Rate Limiting:**
- ‚ö†Ô∏è No implementado en endpoints cr√≠ticos
- **Recomendaci√≥n:** Agregar rate limiting a endpoints de autenticaci√≥n y creaci√≥n

**Validaci√≥n:**
- ‚úÖ Siempre validar input del usuario
- ‚úÖ Usar Form Requests para validaci√≥n compleja
- ‚úÖ Sanitizar datos antes de almacenar

---

## BASE DE DATOS

### Modelos Eloquent

**Relaciones:**
- Usar `with()` para eager loading y evitar N+1 queries
- Definir relaciones en modelos
- Usar `belongsTo`, `hasMany`, `hasOne`, `belongsToMany` seg√∫n corresponda

**Ejemplo:**
```php
// Order.php
public function orderItems()
{
    return $this->hasMany(OrderItem::class);
}

public function commerce()
{
    return $this->belongsTo(Commerce::class);
}

// En controlador, usar eager loading
Order::with(['orderItems.product', 'commerce'])->get();
```

### Migraciones

**Convenciones:**
- Nombre descriptivo: `create_orders_table.php`
- Usar timestamps: `$table->timestamps()`
- Foreign keys con `onDelete('cascade')` o `onDelete('set null')` seg√∫n corresponda
- √çndices en columnas frecuentemente consultadas

**√çndices Recomendados:**
```php
$table->index('status');
$table->index('created_at');
$table->index(['profile_id', 'status']);
```

### Transacciones

**CR√çTICO:** Usar transacciones para operaciones cr√≠ticas:

```php
DB::transaction(function () use ($validated, $userId) {
    $order = Order::create([...]);
    foreach ($validated['products'] as $product) {
        OrderItem::create([...]);
    }
});
```

---

## SERVICIOS Y L√ìGICA DE NEGOCIO

### Organizaci√≥n de Servicios

**Servicios existentes:**
- `OrderService` - Gesti√≥n de √≥rdenes
- `CartService` - Gesti√≥n de carrito ‚úÖ **SOLUCIONADO:** Ahora usa base de datos (tabla `cart_items`)
- `ProductService` - Gesti√≥n de productos
- `RestaurantService` - Gesti√≥n de restaurantes
- `ReviewService` - Gesti√≥n de rese√±as
- `TrackingService` - Seguimiento de entregas
- `PostService` - Gesti√≥n de posts
- `PostLikeService` - Gesti√≥n de likes
- `DeliveryAssignmentService` - Asignaci√≥n de entregas

### Reglas para Servicios

1. **L√≥gica de negocio en servicios, NO en controladores**
2. **Un servicio = una responsabilidad principal**
3. **Reutilizar servicios entre controladores**
4. **Inyectar dependencias, no crear instancias directamente**

### CartService

**‚úÖ SOLUCIONADO:** El carrito ahora usa base de datos

**IMPLEMENTACI√ìN ACTUAL:**
```php
// CartService ahora usa Eloquent (tabla cart_items)
$cartItems = CartItem::where('profile_id', $profileId)->get();
```

**REGLAS DE NEGOCIO:**
- Solo productos de UN comercio por carrito
- Validaci√≥n de disponibilidad y stock
- Asociado a `profile_id` del usuario

---

## API Y ENDPOINTS

### Convenciones REST

**M√©todos HTTP:**
- `GET` - Obtener recursos
- `POST` - Crear recursos
- `PUT` - Actualizar recursos completos
- `PATCH` - Actualizar recursos parciales
- `DELETE` - Eliminar recursos

**Estructura de Respuestas:**
```php
// √âxito
return response()->json([
    'success' => true,
    'data' => $data,
    'message' => 'Operaci√≥n exitosa'
], 200);

// Error
return response()->json([
    'success' => false,
    'message' => 'Mensaje de error',
    'errors' => $errors
], 400);
```

**Status Codes:**
- `200` - OK
- `201` - Created
- `400` - Bad Request
- `401` - Unauthorized
- `403` - Forbidden
- `404` - Not Found
- `422` - Validation Error
- `500` - Server Error

### Paginaci√≥n

**CR√çTICO:** Agregar paginaci√≥n a endpoints de listado:

```php
public function index(Request $request)
{
    $perPage = $request->get('per_page', 15);
    $orders = Order::paginate($perPage);
    
    return response()->json([
        'success' => true,
        'data' => $orders->items(),
        'pagination' => [
            'current_page' => $orders->currentPage(),
            'per_page' => $orders->perPage(),
            'total' => $orders->total(),
            'last_page' => $orders->lastPage(),
        ]
    ]);
}
```

---

## EVENTOS Y NOTIFICACIONES EN TIEMPO REAL

### Eventos

**‚úÖ IMPLEMENTADO:** Firebase Cloud Messaging (FCM) + Pusher (NO WebSocket)

**Eventos existentes:**
- `OrderCreated` - Nueva orden creada
- `OrderStatusChanged` - Estado de orden cambiado
- `PaymentValidated` - Pago validado
- `NewMessage` - Nuevo mensaje de chat
- `DeliveryLocationUpdated` - Ubicaci√≥n de delivery actualizada
- `NotificationCreated` - Nueva notificaci√≥n

**Uso:**
```php
// Disparar evento
event(new OrderStatusChanged($order));

// El evento debe implementar ShouldBroadcast
class OrderStatusChanged implements ShouldBroadcast
{
    public function broadcastOn()
    {
        return new PrivateChannel('user.' . $this->order->profile->user_id);
    }
}
```

### Configuraci√≥n

**Firebase + Pusher:**
- Firebase Cloud Messaging (FCM) - Push notifications a m√≥viles
- Pusher - Broadcasting en tiempo real (web)
- Autenticaci√≥n: Sanctum tokens

**IMPORTANTE:** NO usar WebSocket directamente. Usar Firebase + Pusher para notificaciones en tiempo real.

---

## TESTING

### Estructura de Tests

**Tests de Feature:**
- Ubicaci√≥n: `tests/Feature/`
- Testear endpoints completos
- Usar `RefreshDatabase` trait
- Crear usuarios con factories

**Ejemplo:**
```php
<?php

namespace Tests\Feature;

use Tests\TestCase;
use App\Models\User;
use Laravel\Sanctum\Sanctum;

class OrderTest extends TestCase
{
    use RefreshDatabase;

    public function test_user_can_create_order()
    {
        $user = User::factory()->create(['role' => 'users']);
        Sanctum::actingAs($user);

        $response = $this->postJson('/api/buyer/orders', [
            'commerce_id' => 1,
            'products' => [...],
        ]);

        $response->assertStatus(201)
                 ->assertJson(['success' => true]);
    }
}
```

### Ejecutar Tests

```bash
# Todos los tests
php artisan test

# Tests espec√≠ficos
php artisan test --filter=OrderTest

# Con coverage
php artisan test --coverage
```

---

## MEJORAS CR√çTICAS PENDIENTES

### üî¥ CR√çTICO - Acci√≥n Inmediata

1. ~~**Migrar Carrito de Session a Base de Datos**~~ ‚úÖ **COMPLETADO**
   - ‚úÖ Tabla `carts` y `cart_items` creadas
   - ‚úÖ `CartService` actualizado para usar Eloquent
   - ‚úÖ Validaciones de negocio implementadas

2. **Restringir CORS**
   - Cambiar `allowed_origins: ['*']` a dominios espec√≠ficos
   - Afecta seguridad

3. **Agregar Rate Limiting**
   - Implementar en endpoints cr√≠ticos (auth, creaci√≥n)
   - Afecta seguridad

4. **Ejecutar Migraciones Pendientes**
   - `add_is_default_to_addresses_table.php`
   - `make_company_id_nullable_in_delivery_agents_table.php`
   - `add_stock_quantity_to_products_table.php`
   - `add_image_open_schedule_to_delivery_companies_table.php`

### üü° ALTO - Pr√≥ximas Semanas

4. **Agregar Paginaci√≥n**
   - Implementar en todos los endpoints de listado
   - Afecta performance

5. **Agregar √çndices a BD**
   - `orders.status`, `orders.created_at`
   - `products.commerce_id`, `products.is_available`
   - Afecta performance

6. **Implementar Caching**
   - Redis para queries frecuentes
   - Cachear respuestas de API
   - Afecta performance

### üü¢ MEDIO - Mejoras Futuras

7. **Mejorar Sistema de Roles**
   - Permisos granulares
   - M√∫ltiples roles por usuario
   - Afecta seguridad/flexibilidad

8. **Implementar Swagger/OpenAPI**
   - Documentaci√≥n de API
   - Afecta desarrollo/documentaci√≥n

9. **Eliminar Archivos Duplicados**
   - `City copy.php`, `State copy.php`
   - Afecta mantenibilidad

---

## LOGGING Y MONITOREO

### Logging

**Usar Logger de Laravel:**
```php
use Illuminate\Support\Facades\Log;

Log::info('Order created', ['order_id' => $order->id]);
Log::error('Payment failed', ['error' => $e->getMessage()]);
```

**Recomendaci√≥n:** Implementar logging estructurado para eventos cr√≠ticos.

### Monitoreo

**Recomendaciones:**
- Implementar APM (Sentry, New Relic)
- Monitorear queries lentas
- Alertas para errores cr√≠ticos

---

## DEPLOYMENT Y CONFIGURACI√ìN

### Variables de Entorno

**Cr√≠ticas:**
- `APP_URL` - URL base de la aplicaci√≥n
- `DB_*` - Configuraci√≥n de base de datos
- `BROADCAST_DRIVER` - Driver de broadcasting
- `REDIS_*` - Configuraci√≥n de Redis (si se usa)

### Comandos √ötiles

```bash
# Limpiar cache
php artisan config:clear
php artisan cache:clear
php artisan route:clear

# Optimizar
php artisan config:cache
php artisan route:cache
php artisan view:cache

# Migraciones
php artisan migrate
php artisan migrate:rollback
php artisan migrate:fresh --seed
```

---

## REGLAS ESPEC√çFICAS DEL PROYECTO

### Carrito de Compras

**‚úÖ SOLUCIONADO:** El carrito ahora usa base de datos (tablas `carts` y `cart_items`)

**REGLAS DE NEGOCIO:**
- **NO puede haber productos de diferentes comercios en el mismo carrito**
- Si el usuario intenta agregar un producto de otro comercio, el sistema limpia el carrito autom√°ticamente
- Validaci√≥n de cantidad: min:1, max:100
- Validaci√≥n de disponibilidad: Solo productos `available = true`
- Validaci√≥n de stock: Si tiene `stock_quantity`, verificar que haya suficiente

**Implementaci√≥n:**
- `CartService` usa Eloquent (tabla `cart_items`)
- Asociado a `profile_id` del usuario
- Filtra productos no disponibles autom√°ticamente

### √ìrdenes

**Flujo de Estados (MVP):**
- `pending_payment` ‚Üí `paid` ‚Üí `processing` ‚Üí `shipped` ‚Üí `delivered`
- `pending_payment` ‚Üí `cancelled` (solo si no pagado)

**Validaciones Cr√≠ticas:**
- ‚úÖ Usuario debe tener rol `users` (comprador)
- ‚úÖ Perfil completo: firstName, lastName, phone, **photo_users (required - bloquea si no tiene)**, address si delivery
- ‚úÖ Comercio debe estar activo (`open = true`)
- ‚úÖ Productos disponibles (`available = true`)
- ‚úÖ Stock suficiente (si tiene `stock_quantity` - valida cantidad)
- ‚úÖ Todos los productos del mismo comercio
- ‚úÖ Validaci√≥n de precio: Recalcular y comparar con total enviado
- ‚úÖ Direcci√≥n de entrega (si `delivery_type = 'delivery'`)
- ‚úÖ Usar `DB::transaction` para atomicidad
- ‚úÖ Descontar stock autom√°ticamente al crear orden (si tiene `stock_quantity`)

**Sistema de Delivery:**
- **Jerarqu√≠a:** Delivery Company ‚Üí Delivery Agents
- **Tipos:** Propio del comercio, Empresa de delivery, Independiente (company_id = null)
- **Asignaci√≥n aut√≥noma (IMPLEMENTADA):** 
  1. working=true, 
  2. disponible, 
  3. cercan√≠a inicial 1-1.5km (expansi√≥n autom√°tica a 4-5km si no encuentra),
  4. aceptaci√≥n
- **Expansi√≥n autom√°tica:** Si no encuentra delivery en 1-1.5km, expande autom√°ticamente hasta encontrar disponible

### Eventos y Notificaciones en Tiempo Real

**‚úÖ IMPLEMENTADO:** Firebase Cloud Messaging (FCM) + Pusher (NO WebSocket)

**Eventos:**
- `OrderCreated` - Nueva orden creada
- `OrderStatusChanged` - Estado de orden cambiado
- `PaymentValidated` - Pago validado
- `NewMessage` - Nuevo mensaje de chat
- `DeliveryLocationUpdated` - Ubicaci√≥n de delivery actualizada
- `NotificationCreated` - Nueva notificaci√≥n

**Canales (Pusher):**
- `private-user.{userId}` - Notificaciones de usuario
- `private-order.{orderId}` - Actualizaciones de orden
- `private-chat.{orderId}` - Chat de orden
- `private-commerce.{commerceId}` - Notificaciones de comercio

**Autenticaci√≥n:**
- Usar Sanctum tokens
- Endpoint: `/api/broadcasting/auth`

**IMPORTANTE:** NO usar WebSocket. Usar Firebase + Pusher para notificaciones en tiempo real.

---

## MEJORES PR√ÅCTICAS

### C√≥digo

1. ‚úÖ **Siempre usar Form Requests para validaci√≥n**
2. ‚úÖ **L√≥gica de negocio en Services, NO en Controllers**
3. ‚úÖ **Usar Eager Loading para evitar N+1 queries**
4. ‚úÖ **Usar Transacciones para operaciones cr√≠ticas**
5. ‚úÖ **Manejar errores apropiadamente**
6. ‚úÖ **Documentar m√©todos complejos**

### Seguridad

1. ‚úÖ **Validar TODO el input del usuario**
2. ‚úÖ **Usar prepared statements (Eloquent lo hace autom√°ticamente)**
3. ‚úÖ **Proteger endpoints con middleware de autenticaci√≥n**
4. ‚úÖ **Usar rate limiting en endpoints cr√≠ticos**
5. ‚úÖ **Restringir CORS a dominios espec√≠ficos**
6. ‚úÖ **No exponer informaci√≥n sensible en errores**

### Performance

1. ‚úÖ **Usar Eager Loading**
2. ‚úÖ **Agregar √≠ndices a columnas consultadas frecuentemente**
3. ‚úÖ **Implementar paginaci√≥n**
4. ‚úÖ **Cachear queries frecuentes**
5. ‚úÖ **Optimizar queries complejas**

---

## REFERENCIAS

- **Laravel Docs:** https://laravel.com/docs/10.x
- **Sanctum Docs:** https://laravel.com/docs/10.x/sanctum
- **Eloquent Docs:** https://laravel.com/docs/10.x/eloquent
- **Testing Docs:** https://laravel.com/docs/10.x/testing

---

## AN√ÅLISIS EXHAUSTIVO DEL PROYECTO

### Documento de An√°lisis

**Ubicaci√≥n:** `ANALISIS_EXHAUSTIVO.md` (ra√≠z del proyecto)  
**Versi√≥n de Prompts:** 2.0 - Basada en Experiencia Real

Este documento contiene un an√°lisis exhaustivo completo del proyecto realizado en Diciembre 2024, cubriendo todas las √°reas:
1. Arquitectura y Estructura
2. C√≥digo y Calidad
3. L√≥gica de Negocio
4. Base de Datos
5. Seguridad (OWASP Top 10 completo)
6. Performance (bottlenecks, quick wins, m√©tricas)
7. Testing (cobertura, estrategia, plan de mejora)
8. Frontend
9. Backend/API
10. DevOps e Infraestructura
11. Documentaci√≥n
12. **Verificaci√≥n de Coherencia entre Archivos** ‚≠ê NUEVO
13. Estado y Mantenibilidad
14. Oportunidades y Mejoras

### Realizar An√°lisis Exhaustivo

Cuando se solicite un an√°lisis exhaustivo del proyecto, seguir los **PROMPTS COMPLETOS PARA AN√ÅLISIS EXHAUSTIVO v2.0** disponibles. Estos prompts proporcionan un marco estructurado para an√°lisis profundos con verificaci√≥n de coherencia.

**PROMPT MAESTRO - AN√ÅLISIS COMPLETO v2.0:**

```
Realiza un AN√ÅLISIS COMPLETO Y EXHAUSTIVO del proyecto Zonix Eats Backend.

INSTRUCCIONES GENERALES:
- Explora TODA la estructura del proyecto sin dejar √°reas sin revisar
- Lee y analiza los archivos m√°s importantes de cada m√≥dulo
- Identifica patrones, anti-patrones y code smells
- Proporciona ejemplos concretos de c√≥digo cuando sea relevante (formato: archivo:l√≠nea)
- Prioriza hallazgos por criticidad (cr√≠tico, alto, medio, bajo)
- Sugiere mejoras espec√≠ficas y accionables con estimaci√≥n de esfuerzo
- **VERIFICA COHERENCIA** entre diferentes archivos de documentaci√≥n (README, .cursorrules, etc.)

METODOLOG√çA DE AN√ÅLISIS:

FASE 1: EXPLORACI√ìN INICIAL
1. Mapear estructura completa de directorios y archivos
2. Identificar archivos de configuraci√≥n clave (composer.json, .env.example, etc.)
3. Leer archivos de documentaci√≥n principales (README.md, .cursorrules, CHANGELOG.md, etc.)
4. Identificar stack tecnol√≥gico completo y versiones
5. Mapear dependencias principales y secundarias

FASE 2: AN√ÅLISIS PROFUNDO POR √ÅREA
Realiza an√°lisis exhaustivo en estas secciones:
1. ARQUITECTURA Y ESTRUCTURA
   - Mapea TODA la estructura de directorios y archivos
   - Identifica patr√≥n arquitect√≥nico principal (MVC)
   - Lista stack tecnol√≥gico completo con versiones
   - Analiza configuraci√≥n y entorno

2. C√ìDIGO Y CALIDAD
   - Revisa consistencia de estilo y convenciones
   - Analiza complejidad ciclom√°tica
   - Detecta duplicaci√≥n de c√≥digo (DRY violations)
   - Identifica code smells y anti-patrones
   - Eval√∫a aplicaci√≥n de principios SOLID

3. L√ìGICA DE NEGOCIO
   - Identifica TODOS los modelos de dominio y relaciones
   - Mapea flujos de trabajo principales
   - Analiza servicios y capa de negocio
   - Revisa integraciones externas

4. BASE DE DATOS
   - Mapea esquema COMPLETO (tablas, columnas, tipos)
   - Analiza relaciones y constraints
   - Identifica queries lentas o problem√°ticas
   - Detecta problemas N+1
   - Revisa √≠ndices existentes y faltantes

5. SEGURIDAD
   - Analiza autenticaci√≥n y autorizaci√≥n (Sanctum)
   - Eval√∫a protecci√≥n de datos
   - Revisa validaci√≥n de entrada
   - Identifica vulnerabilidades OWASP Top 10
   - Analiza gesti√≥n de secretos

6. PERFORMANCE
   - Identifica bottlenecks en c√≥digo
   - Analiza tiempo de respuesta de APIs
   - Eval√∫a queries de base de datos
   - Revisa estrategias de caching
   - Analiza escalabilidad

7. TESTING
   - Analiza cobertura de tests (204 pasaron, 0 fallaron - verificado Enero 2025)
   - Eval√∫a estrategia de testing
   - Revisa calidad de tests existentes
   - Identifica √°reas sin cobertura

8. BACKEND/API
   - Mapea TODOS los endpoints (232 rutas verificadas)
   - Analiza dise√±o de API (RESTful)
   - Eval√∫a middleware y procesamiento
   - Revisa validaci√≥n y seguridad
   - Analiza performance y escalabilidad

9. DEVOPS E INFRAESTRUCTURA
   - Analiza CI/CD (si existe)
   - Revisa infraestructura y hosting
   - Eval√∫a monitoreo y alerting
   - Analiza dependencias y vulnerabilidades

10. DOCUMENTACI√ìN
    - Eval√∫a README y documentaci√≥n t√©cnica
    - Revisa comentarios en c√≥digo
    - Identifica documentaci√≥n faltante
    - Eval√∫a calidad de documentaci√≥n

11. ESTADO Y MANTENIBILIDAD
    - Identifica funcionalidades completadas
    - Analiza features en desarrollo
    - Eval√∫a technical debt acumulado
    - Calcula m√©tricas del proyecto

12. OPORTUNIDADES Y MEJORAS
    - Identifica quick wins
    - Prioriza refactorizaciones necesarias
    - Sugiere optimizaciones cr√≠ticas
    - Crea roadmap t√©cnico

Para cada secci√≥n, proporciona:
- An√°lisis detallado con hallazgos espec√≠ficos (con ubicaciones de archivos)
- Fortalezas identificadas (‚úÖ)
- Debilidades y problemas encontrados (‚ö†Ô∏è o ‚ùå)
- Ejemplos concretos de c√≥digo o referencias a archivos (usar formato archivo:l√≠nea)
- Recomendaciones priorizadas con:
  - Impacto estimado (Alto/Medio/Bajo)
  - Esfuerzo estimado (horas/semanas)
  - Prioridad (Cr√≠tica/Alta/Media/Baja)
- M√©tricas cuantificables cuando sea posible

FORMATO DE SALIDA:
1. RESUMEN EJECUTIVO (al inicio):
   - Estado general del proyecto
   - Fortalezas principales (top 5)
   - √Åreas de mejora cr√≠ticas (top 5)
   - Score de mantenibilidad (X/10)
   - Recomendaci√≥n general (Production Ready / Necesita Mejoras / Cr√≠tico)

2. AN√ÅLISIS POR SECCI√ìN con subsecciones numeradas
3. CHECKLIST DE VERIFICACI√ìN FINAL antes de considerar completo
```

**PROMPTS ESPEC√çFICOS DISPONIBLES (v2.0):**

Adem√°s del prompt maestro, existen prompts espec√≠ficos para an√°lisis profundos:
- **PROMPT 1:** An√°lisis Arquitect√≥nico y Estructural
- **PROMPT 2:** An√°lisis de C√≥digo y Calidad
- **PROMPT 3:** An√°lisis de L√≥gica de Negocio
- **PROMPT 4:** An√°lisis de Base de Datos
- **PROMPT 5:** An√°lisis de Seguridad (OWASP Top 10 completo con checklist)
- **PROMPT 6:** An√°lisis de Performance (bottlenecks, quick wins, m√©tricas)
- **PROMPT 7:** An√°lisis de Testing (cobertura, estrategia, plan de mejora)
- **PROMPT 9:** An√°lisis de Backend/API
- **PROMPT 10:** An√°lisis de DevOps e Infraestructura
- **PROMPT 11:** An√°lisis de Documentaci√≥n
- **PROMPT 12:** ‚≠ê **Verificaci√≥n de Coherencia entre Archivos** (NUEVO - CR√çTICO)
- **PROMPT 13:** An√°lisis de Estado y Mantenibilidad
- **PROMPT 14:** An√°lisis de Oportunidades y Mejoras (con roadmap t√©cnico)

**Prompts Espec√≠ficos Adicionales:**
- An√°lisis R√°pido pero Completo (versi√≥n concisa)
- An√°lisis para Refactorizaci√≥n
- An√°lisis para Onboarding
- An√°lisis de Seguridad Profundo
- An√°lisis de Performance Profundo
- An√°lisis de Arquitectura Profundo
- An√°lisis de L√≥gica de Negocio Profundo

**Ver:** `prompts_analisis_completo.txt` (si existe) para prompts completos y detallados v2.0.

### Checklist de Verificaci√≥n Final

Antes de considerar el an√°lisis completo, verificar:
- ‚úÖ Todas las 14 secciones principales fueron analizadas
- ‚úÖ Se verific√≥ coherencia entre diferentes archivos de documentaci√≥n
- ‚úÖ Se identificaron y corrigieron discrepancias encontradas
- ‚úÖ Las m√©tricas mencionadas son consistentes en toda la documentaci√≥n
- ‚úÖ Se incluyeron m√©tricas cuantificables cuando fue posible
- ‚úÖ Se proporcionaron estimaciones de esfuerzo para mejoras sugeridas
- ‚úÖ Se complet√≥ el checklist OWASP Top 10 completo
- ‚úÖ Se identificaron quick wins (alto impacto, bajo esfuerzo)
- ‚úÖ Se cre√≥ un roadmap t√©cnico con corto/medio/largo plazo

### Actualizar An√°lisis

**Cu√°ndo actualizar:**
- Despu√©s de cambios arquitect√≥nicos importantes
- Despu√©s de implementar mejoras cr√≠ticas
- Cada 3-6 meses o cuando se solicite
- Antes de releases mayores

**C√≥mo actualizar:**
1. Revisar cambios desde √∫ltimo an√°lisis
2. Ejecutar an√°lisis exhaustivo siguiendo prompts
3. Actualizar `ANALISIS_EXHAUSTIVO.md`
4. Actualizar esta secci√≥n con fecha de √∫ltima actualizaci√≥n

---

**√öltima actualizaci√≥n:** Enero 2025  
**Mantener este archivo actualizado con cambios arquitect√≥nicos importantes**

---

## L√ìGICA DE NEGOCIO - MVP (Actualizado Enero 2025)

### Decisiones Clave del MVP

1. **Carrito:** NO puede haber productos de diferentes comercios (uni-commerce)
2. **Validaci√≥n de Precio:** Recalcular y validar contra total enviado
3. **Stock:** AMBAS opciones (`available` Y `stock_quantity`) - Validar siempre available, si tiene stock_quantity validar cantidad
4. **Delivery:** Sistema completo (propio, empresas, independientes) + Asignaci√≥n aut√≥noma con expansi√≥n de √°rea
5. **Eventos:** Firebase + Pusher (NO WebSocket)
6. **Perfiles:** Datos m√≠nimos (USERS) vs completos (COMMERCE, DELIVERY)
7. **photo_users:** Required estricto (bloquea creaci√≥n de orden)
8. **Geolocalizaci√≥n Comercios:** B√∫squeda inicial 1-1.5km, expansi√≥n autom√°tica a 4-5km
9. **Asignaci√≥n Delivery:** Aut√≥noma con expansi√≥n autom√°tica de √°rea (1-1.5km ‚Üí 4-5km ‚Üí continua)
10. **Cancelaci√≥n:** L√≠mite 5 minutos O hasta validaci√≥n de pago
11. **Reembolsos:** Manual (no autom√°tico)

### üí∞ MODELO DE NEGOCIO - RESUMEN

**Costos y Precios:**
- **Costo Delivery:** H√≠brido (Base fija $2.00 + $0.50/km despu√©s de 2 km) - Configurable por admin
- **Qui√©n paga delivery:** Cliente (se agrega al total de la orden)
- **Membres√≠a/Comisi√≥n:** Membres√≠a mensual obligatoria (base) + Comisi√≥n % sobre ventas del mes (extra)
  - Ejemplo: $100/mes + 10% de ventas = $100 + $500 (si vendi√≥ $5,000) = $600 total
- **M√≠nimo pedido:** No hay m√≠nimo
- **Tarifa servicio:** No hay (solo subtotal + delivery)
- **Propinas:** No permitidas

**Pagos:**
- **M√©todos:** Todos (efectivo, transferencia, tarjeta, pago m√≥vil, digitales)
- **Qui√©n recibe:** Comercio directamente (con sus datos bancarios)
- **Manejo:** Tiempo real (validaci√≥n manual de comprobante)
- **Pago a delivery:** Del comercio (despu√©s de recibir pago del cliente) ‚Üí **Delivery recibe 100% del delivery_fee** (Opci√≥n A confirmada)

**L√≠mites:**
- **Distancia m√°xima:** 60 minutos de tiempo estimado de viaje
- **Quejas/Disputas:** Sistema de tickets con admin (tabla `disputes`)

**Horarios:**
- **Comercios:** Definen horarios + campo `open` manual
- **Delivery:** 24/7 seg√∫n disponibilidad (campo `working`)

**Ver README.md secci√≥n completa "üí∞ MODELO DE NEGOCIO" para detalles detallados.**

### Penalizaciones y Tiempos L√≠mite

**Cancelaciones:**
- **Comercio:** Puede cancelar en `paid`/`processing` con justificaci√≥n. Penalizaci√≥n si excede l√≠mite (5 cancelaciones/30 d√≠as)
- **Cliente:** Solo en `pending_payment`, l√≠mite 5 minutos. Penalizaci√≥n si crea m√∫ltiples √≥rdenes sin pagar
- **Comisi√≥n en cancelaci√≥n:** Si comercio cancela despu√©s de `paid`, se cobra comisi√≥n como penalizaci√≥n adicional

**Delivery rechaza:**
- Debe justificar. Penalizaci√≥n si rechaza 3-5 √≥rdenes seguidas sin justificaci√≥n v√°lida
- Ideal: Bajar switch `working = false` si no est√° disponible

**Tiempos l√≠mite:**
- Cliente sube comprobante: 5 minutos (cancelaci√≥n autom√°tica si no sube)
- Comercio valida pago: 5 minutos (cancelaci√≥n autom√°tica si no valida)
- Notificaciones autom√°ticas antes de timeout

**Rating/Reviews:**
- Obligatorio despu√©s de orden `delivered`
- Comercio y delivery se califican por separado
- No editables ni eliminables

**Promociones:**
- Manual (comercio y admin pueden crear)
- C√≥digo promocional O autom√°tico seg√∫n tipo

### Direcciones y Geolocalizaci√≥n

**USERS tiene 2 direcciones:**
1. **Predeterminada (Casa):** `is_default = true` en tabla `addresses`
   - **Uso:** Base para b√∫squeda de comercios por geolocalizaci√≥n
   - **Ubicaci√≥n:** GPS + inputs y selects para mayor precisi√≥n
2. **Entrega (Pedido):** Puede ser diferente, se guarda temporalmente o como nueva direcci√≥n
   - **Ubicaci√≥n:** GPS + inputs y selects para mayor precisi√≥n

**B√∫squeda de Comercios por Geolocalizaci√≥n:**
- **Rango inicial:** 1-1.5 km desde direcci√≥n predeterminada del usuario
- **Expansi√≥n autom√°tica:** Si no hay comercios abiertos, expande autom√°ticamente a 4-5 km
- **Expansi√≥n manual:** Usuario puede ampliar rango si desea buscar m√°s lejos
- **C√°lculo:** Haversine para calcular distancia entre coordenadas GPS

### Campos Requeridos por Rol

**USERS:** firstName, lastName, phone, photo_users (required)
**COMMERCE:** 7 campos requeridos + 16 opcionales
**DELIVERY COMPANY:** 9 campos requeridos + campos opcionales (igual estructura que COMMERCE)
**DELIVERY AGENT:** 7 campos requeridos + campos opcionales

**IMPORTANTE:** Ver README.md secci√≥n completa "üìã DATOS REQUERIDOS POR ACCI√ìN Y ROL" para detalles espec√≠ficos de cada campo.
